<html>
	<head>
		<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
        <script src="./dist/cellauto.js"></script>

		<script>

var TOPLEFT = { x: -1, y: -1, index: 0 };
var TOP = { x: 0, y: -1, index: 1 };
var TOPRIGHT = { x: 1, y: -1, index: 2 };
var LEFT = { x: -1, y: 0, index: 3 };
var RIGHT = { x: 1, y: 0, index: 4 };
var BOTTOMLEFT = { x: -1, y: 1, index: 5 };
var BOTTOM = { x: 0, y: 1, index: 6 };
var BOTTOMRIGHT = { x: 1, y: 1, index: 7 };


window.onload = function() {


	var world = new CAWorld({
		width: 40,
		height: 30,
		cellSize: 8
	});

    world.registerCellType('water', {
        color: '89, 125, 206',
        getDensity: function() {
            return (this.water/9);
        },
        process: function(neighbors) {
            // top
            for (var i=0; i<=2; i++) {
                if (neighbors[i] !== null && this.water < 9 && neighbors[i].water) {
                    this.water++;
                    neighbors[i].water--;
                }
            }
            // sides
            for (i=3; i<=4; i++) {
                if (neighbors[i] !== null && neighbors[i].water > this.water) {
                    this.water++;
                    neighbors[i].water--;
                }
            }
        }
    }, function() {
        this.water = Math.floor(Math.random() * 9);
    });

    world.registerCellType('rock', {
        color: '68, 36, 52'
    });

    world.initialize([
        { name: 'water', distribution: 70 },
        { name: 'rock', distribution: 30 }
    ]);

	var drawnGrid = document.getElementById('drawnGrid');
	
	var myCanvas = document.getElementById('myCanvas');
	myCanvas.width = world.cellSize * world.width;
	myCanvas.height = world.cellSize * world.height;
	var ctx = myCanvas.getContext('2d');

    var frames = 0;
	function loop() {

        // limit speed of simulation
        if(frames % 3 === 0) {
            world.step();
            drawGrid(ctx, world);
        }

        requestAnimationFrame(loop);

        frames++;
	};

    requestAnimationFrame(loop);
};

function drawGrid(ctx, world) {
	ctx.clearRect(0, 0, world.width*world.cellSize, world.height*world.cellSize);

	for (var y=0; y<world.height; y++) {
		for (var x=0; x<world.width; x++) {
            if (world.grid[y][x].cellType === 'water') {
                ctx.fillStyle = 'rgba(' + world.grid[y][x].color + ', ' + world.grid[y][x].getDensity() + ')';
            }
            else {
                ctx.fillStyle = 'rgb(' + world.grid[y][x].color + ')';
            }
			//var size = Math.ceil(world.cellSize * world.grid[y][x].getDensity());
			//var xLoc = x*world.cellSize + world.cellSize/2 - Math.ceil(size/2);
			//var yLoc = y*world.cellSize + world.cellSize/2 - Math.round(size/2);
			//ctx.fillRect(xLoc, yLoc, size, size);
			ctx.fillRect(x*world.cellSize, y*world.cellSize, world.cellSize, world.cellSize);
		}
	}
}


function CellAutoRock(locX, locY, options) {
	this.x = locX;
	this.y = locY;

	//this.color = "133, 76, 48";
	this.color = "68, 36, 52";
	
	this.initialize = function() {
		if (options) {
			for (var key in options) {
				this[key] = options[key];
			}
		}

		this.reset();
	};
	
	this.reset = function() {
		//this.hadWater = this.water;
	};
	
	this.initialize();
};

CellAutoRock.prototype.getDensity = function(neighbors) {
	return 1;
};

CellAutoRock.prototype.process = function(neighbors) {
	
};

function CellAutoWater(locX, locY, options) {
	this.x = locX;
	this.y = locY;

	this.water = Math.floor(Math.random() * 9);
	this.color = "89, 125, 206";
	
	this.initialize = function() {
		if (options) {
			for (var key in options) {
				this[key] = options[key];
			}
		}

		this.reset();
	};
	
	this.reset = function() {
		//this.hadWater = this.water;
	};
	
	this.initialize();
};

CellAutoWater.prototype.getDensity = function(neighbors) {
	return (this.water/9);
};

CellAutoWater.prototype.process = function(neighbors) {
	
	var i;
	// top
	for (i=0; i<=2; i++) {
		if (neighbors[i] !== null && this.water < 9 && neighbors[i].water) {
			this.water++;
			neighbors[i].water--;
		}
	}	
	// sides
	for (i=3; i<=4; i++) {
		if (neighbors[i] !== null && neighbors[i].water > this.water) {
			this.water++;
			neighbors[i].water--;
		}
	
	}
	
};

function CellAutoGoL(locX, locY, options) {
	this.x = locX;
	this.y = locY;

	this.alive = Math.random() > 0.3;
	
	this.initialize = function() {
		if (options) {
			for (var key in options) {
				this[key] = options[key];
			}
		}

		this.reset();
	};
	
	this.reset = function() {
		this.wasAlive = this.alive;
	};
	
	this.initialize();
};

CellAutoGoL.prototype.process = function(neighbors) {
	
	var surrounding = 0;
	for (var i=0; i<neighbors.length; i++) {
		if (neighbors[i] !== null && neighbors[i].wasAlive) {
			surrounding++;
		}
	}
	this.alive = surrounding === 3 || surrounding === 2 && this.alive;
};

		</script>

	</head>
	
	<body>
		<div id="drawnGrid" style="font-family: 'Courier New', Courier, monospace;"></div>
		<canvas id="myCanvas" />
	</body>
</html>