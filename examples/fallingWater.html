<!DOCTYPE html>
<html>
	<head>
		<link rel="shortcut icon" href="data:image/x-icon;," type="image/x-icon"> 
        <script src="../dist/cellauto.js"></script>

        <style>
            body {
                margin: 0;
                text-align: center;
            }
        </style>
		<script>

window.onload = function() {


	var world = new CAWorld({
		width: 100,
		height: 66,
		cellSize: 6
	});

    world.registerCellType('water', {
        getColor: function() {
            return '89, 125, 206, ' + (this.water ? Math.max(0.3, this.water/9) : 0);
        },
        process: function(neighbors) {
            if (this.water === 0) {
                // already empty
                return;
            }
            // bottom
            if (neighbors[world.BOTTOM] !== null && this.water && neighbors[world.BOTTOM].water < 9) {
                // all of it
                var amt = Math.min(this.water, 9 - neighbors[world.BOTTOM].water);
                this.water-= amt;
                neighbors[world.BOTTOM].water += amt;
                return;
            }

            // bottom with corners
            for (var i=5; i<=7; i++) {
                if (i!=world.BOTTOM && neighbors[i] !== null && this.water && neighbors[i].water < 9) {
                    // half of it
                    var amt = Math.min(this.water, Math.ceil((9 - neighbors[i].water)/2));
                    this.water-= amt;
                    neighbors[i].water += amt;
                    return;
                }
            }
            // sides
            for (i=3; i<=4; i++) {
                if (neighbors[i] !== null && neighbors[i].water < this.water) {
                    // third of it
                    var amt = Math.min(this.water, Math.ceil((9 - neighbors[i].water)/3));
                    this.water-= amt;
                    neighbors[i].water += amt;
                    return;
                }
            }
        }
    }, function() {
        this.water = Math.floor(Math.random() * 9);
    });

    world.registerCellType('rock', {
        getColor: function() {
            return '68, 36, 52, 1';
        }
    });

    world.initialize([
        { name: 'water', distribution: 70 },
        { name: 'rock', distribution: 30 }
    ]);

	var myCanvas = document.getElementById('myCanvas');
	myCanvas.width = world.cellSize * world.width;
	myCanvas.height = world.cellSize * world.height;
	var ctx = myCanvas.getContext('2d');

    var frames = 0;
	function loop() {

        // limit speed of simulation
        if(frames % 3 === 0) {
            world.step();
            drawGrid(ctx, world);
        }

        requestAnimationFrame(loop);

        frames++;
	};

    requestAnimationFrame(loop);
};

function drawGrid(ctx, world) {
	ctx.clearRect(0, 0, world.width*world.cellSize, world.height*world.cellSize);

	for (var y=0; y<world.height; y++) {
		for (var x=0; x<world.width; x++) {
            ctx.fillStyle = 'rgba(' + world.grid[y][x].getColor() + ')';
			ctx.fillRect(x*world.cellSize, y*world.cellSize, world.cellSize, world.cellSize);
		}
	}
}

		</script>

	</head>
	
	<body>
		<canvas id="myCanvas" />
	</body>
</html>